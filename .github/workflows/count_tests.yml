name: Count Tests and Generate Badge

on:
  push:
    branches:
      - main
      - master

jobs:
  update_test_count:
    runs-on: ubuntu-latest
    environment: badges
    steps:
      - name: Checkout Zipher Repository
        uses: actions/checkout@v4
        with:
          path: zipher

      - name: Count Test Functions
        id: test_count_step
        run: |
         cd zipher
         TEST_COUNT=$(grep -r '#\[test\]' . | wc -l | xargs)
         echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_OUTPUT
      
      - name: Checkout Badges Repository
        uses: actions/checkout@v4
        with:
          repository: pas2rust/badges
          path: badges
          token: ${{ secrets.BADGE_TOKEN }}

      - name: Generate Dynamic Badge SVG
        run: |
          TEST_COUNT=${{ steps.test_count_step.outputs.TEST_COUNT }}
          # Calculate the number of digits in TEST_COUNT
          DIGITS=${#TEST_COUNT}

          # Fixed width for the "Tests" text (approx. 47px)
          LABEL_WIDTH=47

          # Width of each character (approx. 7px per digit + 10px padding)
          NUMBER_WIDTH=$(( DIGITS * 7 + 10 ))

          # X position for the number text
          NUMBER_TEXT_X=$(( LABEL_WIDTH + NUMBER_WIDTH / 2 ))

          # Total badge width
          TOTAL_WIDTH=$(( LABEL_WIDTH + NUMBER_WIDTH ))

          # X position for the green rectangle (starts after the gray part)
          GREEN_RECT_X=$LABEL_WIDTH

          cat > badges/zipher-tests.svg <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="$TOTAL_WIDTH" height="20" viewBox="0 0 $TOTAL_WIDTH 20" role="img" aria-label="Tests: $TEST_COUNT">
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <clipPath id="r"><rect width="$TOTAL_WIDTH" height="20" rx="3" fill="#fff"/></clipPath>
            <g clip-path="url(#r)">
              <rect width="$LABEL_WIDTH" height="20" fill="#555"/>
              <rect x="$GREEN_RECT_X" width="$NUMBER_WIDTH" height="20" fill="#4c1"/>
              <rect width="$TOTAL_WIDTH" height="20" fill="url(#s)"/>
            </g>
            <g fill="#fff" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11" text-rendering="geometricPrecision">
              <text x="23.5" y="14" text-anchor="middle">
                <svg viewBox="0 0 512 512" x="10" y="-3" width="16" height="16" style="fill:#fff;">
                  <g>
                    <path d="M441.984,0c-11.865-0.008-21.495,9.58-21.495,21.446c-0.016,11.858,9.58,21.47,21.437,21.486c11.858,0.017,21.479-9.588,21.495-21.454C463.429,9.63,453.841,0.008,441.984,0z"/>
                    <path d="M445.713,102.307c0.008-6.978-5.631-12.64-12.6-12.649c-6.977,0-12.64,5.647-12.649,12.625c0,6.976,5.639,12.632,12.616,12.632C440.058,114.931,445.713,109.276,445.713,102.307z"/>
                    <path d="M473.116,55.663c-8.34-0.017-15.113,6.724-15.113,15.055c-0.008,8.34,6.748,15.097,15.088,15.122c8.324,0,15.089-6.74,15.106-15.089C488.204,62.427,481.455,55.663,473.116,55.663z"/>
                    <path d="M98.855,436.949c53.492,53.483,140.514,53.483,193.997,0c21.291-21.299,34.731-48.261,38.86-77.997c1.444-10.413,1.656-20.956,0.702-31.385H59.31C55.793,366.696,68.971,407.057,98.855,436.949z M242.838,374.603c5.752,0,10.404,4.668,10.404,10.413c0,5.753-4.652,10.404-10.404,10.404c-5.745,0-10.413-4.651-10.413-10.404C232.425,379.271,237.093,374.603,242.838,374.603z M198.901,424.023c7.582,0,13.734,6.145,13.734,13.726c0,7.581-6.152,13.726-13.734,13.726c-7.581,0-13.725-6.145-13.725-13.726C185.176,430.168,191.321,424.023,198.901,424.023z M147.083,366.99c9.336,0,16.9,7.565,16.9,16.9s-7.564,16.891-16.9,16.891c-9.327,0-16.901-7.556-16.901-16.891S137.756,366.99,147.083,366.99z"/>
                    <path d="M381.694,93.16l-0.571-0.572c-5.623-5.639-13.212-8.781-21.176-8.772c-7.956-0.008-15.562,3.134-21.176,8.772c-5.63,5.623-8.788,13.212-8.781,21.185c0,0.922,0.058,1.828,0.131,2.733l-65.642,65.651c-21.56-9.352-44.997-14.248-68.638-14.248c-45.918-0.017-89.184,17.904-121.647,50.374c-32.478,32.462-50.398,75.745-50.39,121.664c-0.008,45.918,17.912,89.201,50.39,121.663c32.462,32.479,75.745,50.399,121.664,50.391c45.919,0.008,89.202-17.912,121.664-50.391c26.684-26.668,43.568-60.574,48.734-97.859c1.085-7.801,1.624-15.676,1.624-23.518c0-23.658-4.864-47.241-14.24-68.899l65.658-65.65c0.906,0.074,1.82,0.13,2.734,0.13c7.973,0.008,15.562-3.142,21.184-8.772c5.37-5.353,8.471-12.494,8.74-20.033l0.033-0.066v-1.085c0.008-7.965-3.134-15.554-8.773-21.176L381.694,93.16z M330.488,267.408c31.23,57.915,22.409,131.734-26.512,180.656c-29.86,29.867-68.98,44.784-108.118,44.784c-39.129,0-78.266-14.925-108.117-44.784c-59.718-59.711-59.718-156.517,0-216.235c29.851-29.859,68.972-44.776,108.1-44.776c24.988,0,49.983,6.096,72.554,18.263l76.676-76.667l62.084,62.084L330.488,267.408z M429.67,183.495c-2.106,2.114-4.864,3.166-7.638,3.166c-1.469,0-2.938-0.318-4.317-0.914l0.196-0.188l-67.347-67.348l-0.302,0.302c-1.975-4.023-1.305-9.034,2.048-12.38c2.114-2.113,4.872-3.166,7.638-3.166c2.767,0,5.533,1.053,7.638,3.166l62.084,62.084C433.888,172.438,433.897,179.268,429.67,183.495z"/>
                  </g>
                </svg> tests 
              </text>
              <text x="$NUMBER_TEXT_X" y="14" text-anchor="middle">$TEST_COUNT</text>
            </g>
          </svg>
          EOF

      - name: Auto-Commit Badge
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Update zipher test count badge"
          file_pattern: 'zipher-tests.svg'
          repository: badges
          skip_dirty_check: true
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: pas2rust <pas2rust@users.noreply.github.com>
          commit_options: '--allow-empty'   # <-- create empty commit if nothing changed       
          token: ${{ secrets.BADGE_TOKEN }} # required to push to pas2rust/badges
